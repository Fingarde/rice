- name: Update system
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: true
  become_method: sudo

- name: Download Installer
  get_url:
    url: https://sh.rustup.rs
    dest: /tmp/sh.rustup.rs
    mode: '0755'
    force: 'yes'
  tags:
    - rust

- name: Install rust
  ansible.builtin.shell: /tmp/sh.rustup.rs -y

# check if path is already set
- name: Check if rust is already in path
  ansible.builtin.shell: grep -q 'export PATH="$HOME/.cargo/bin:$PATH"' ~/.bashrc
  register: rust_in_path
  ignore_errors: true

# add rust to path
- name: Add rust to path
  ansible.builtin.shell: echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
  when: rust_in_path.rc != 0

- name: Create build directory
  ansible.builtin.file:
    path:  ~/.rice/build
    state: directory

# clone eww "https://github.com/elkowar/eww.git"
- name: Clone eww
  ansible.builtin.git:
    repo: https://github.com/elkowar/eww.git
    dest: ~/.rice/build/eww

- name: Build eww
  ansible.builtin.shell: cargo build --release --no-default-features --features x11
  args:
    chdir: ~/.rice/build/eww

- name: Install eww
  ansible.builtin.shell: cp ~/.rice/build/eww/target/release/eww /usr/local/bin
  become: true
  become_method: sudo

- name: Create eww directory
  ansible.builtin.file:
    path:  /home/timothe/.config/eww
    state: directory